<!-- ========================================
     CONTAINER PRINCIPAL DO CHAT
     ======================================== -->
<div class="chat-content">

  <!-- ========================================
       CABEÇALHO DO CHAT
       - Ícone do assistente (Lisi ou MarIA)
       - Nome e status
       - Botão de fechar
       ======================================== -->
  <div class="chat-header">
    <div class="icon">
      <img *ngIf="clientKey == 'C7VY7HCVF47H3F4'" src="https://sociiz-public-bucket.s3.us-east-1.amazonaws.com/marIA.png" alt="">
      <img *ngIf="clientKey == '49fa27aab4f70b8eaacf'" [src]="'https://sociiz-public-bucket.s3.us-east-1.amazonaws.com/lisi.png?cb=' + cacheBuster" alt="">
      <img *ngIf="clientKey == '5237XCA0IU2VAR2D12BN'" src="https://sociiz-public-bucket.s3.us-east-1.amazonaws.com/ana-clara-avatar.png" alt="">
      <img *ngIf="clientKey == '938VF4YU8HVU8HVF4U8H'" src="https://sociiz-public-bucket.s3.us-east-1.amazonaws.com/ana-clara-avatar.png" alt="">
      <img *ngIf="clientKey == '954GBBG4NY73VF478VB5'" src="https://sociiz-public-bucket.s3.us-east-1.amazonaws.com/manzzo-avatar.png" alt="">
      <!-- <img *ngIf="clientKey == '49fa27aab4f70b8eaacf'" [src]="'https://sociiz-public-bucket.s3.us-east-1.amazonaws.com/lisi.png?cb=' + cacheBuster" alt=""> -->
    </div>
    <!-- Painel de configuração Lisi -->
    <div *ngIf="lisiConfigPanelOpen && clientKey == '49fa27aab4f70b8eaacf'" class="lisi-config-panel">
      <div class="lisi-config-header">
        <h3 class="lisi-config-title">Configurações</h3>
      </div>
      <div class="lisi-config-body">
        <div class="lisi-config-option">
          <label class="switch">
            <input type="checkbox" [ngModel]="lisiConfig.tts" (ngModelChange)="updateLisiConfig('tts', $event)"><span class="slider"></span>
          </label>
          <span class="option-label">Leitura de texto (TTS)</span>
        </div>
        <div class="lisi-config-option">
          <label class="switch">
            <input type="checkbox" [ngModel]="lisiConfig.stt" (ngModelChange)="updateLisiConfig('stt', $event)"><span class="slider"></span>
          </label>
          <span class="option-label">Fala para texto (STT)</span>
        </div>
        <!-- <div class="lisi-config-option">
          <label class="switch">
            <input type="checkbox" [ngModel]="lisiConfig.signLanguage" (ngModelChange)="updateLisiConfig('signLanguage', $event)"><span class="slider"></span>
          </label>
          <span class="option-label">Tradução Libras (VLibras)</span>
        </div>
        <div class="lisi-config-option">
          <label class="switch">
            <input type="checkbox" [ngModel]="lisiConfig.darkMode" (ngModelChange)="updateLisiConfig('darkMode', $event)"><span class="slider"></span>
          </label>
          <span class="option-label">Modo escuro</span>
        </div>
        <div class="lisi-config-option">
          <label class="switch">
            <input type="checkbox" [ngModel]="lisiConfig.largeFont" (ngModelChange)="updateLisiConfig('largeFont', $event)"><span class="slider"></span>
          </label>
          <span class="option-label">Aumentar fonte</span>
        </div> -->
      </div>
    </div>
    
    <div class="nome">
      <h1 *ngIf="clientKey == 'C7VY7HCVF47H3F4'">MarIA</h1>
      <h1 *ngIf="clientKey == '49fa27aab4f70b8eaacf'">Lisi</h1>
      <h1 *ngIf="clientKey == '5237XCA0IU2VAR2D12BN'">Ana Clara</h1>
      <h1 *ngIf="clientKey == '938VF4YU8HVU8HVF4U8H'">Ana Clara</h1>
      <h1 *ngIf="clientKey == '954GBBG4NY73VF478VB5'">Chef B</h1>
      <p>Online</p>
    </div>
    
    <div class="buttons-container">
      <button
        *ngIf="clientKey == '49fa27aab4f70b8eaacf'"
        class="config-btn"
        (click)="toggleLisiConfigPanel()"
        aria-label="Configurações"
        style="margin-left: 10px; background: transparent; border: none; cursor: pointer;"
      >
        <img src="assets/icons/ic--config.svg" alt="Configurações">
      </button>
      <button class="close-button" (click)="closeChat()">
        <img src="assets/icons/ic--round-close.svg" alt="Fechar">
      </button>
    </div>
  </div>

  <!-- ========================================
       ÁREA DE CONTEÚDO DO CHAT
       ======================================== -->
  <div class="chat-box">

    <!-- ========================================
         TELA DE ESPERA NA FILA
         Exibida quando o usuário está aguardando atendimento
         ======================================== -->
    <div class="chat-waiting-window" *ngIf="estaEsperandoAtendimento">
      <div class="waiting-content">
        <h2 class="greeting">Olá, {{ salaPrincipal.cliNome ? salaPrincipal.cliNome : 'visitante'}}!</h2>
        <p class="message">Você está na fila de atendimento e em breve será respondido.<br />Acompanhe abaixo o andamento.</p>
        <p class="protocol">O seu protocolo é: <strong>#{{ salaPrincipal.ombProtocolo }}</strong></p>
        
        <!-- Posição na fila com spinner -->
        <div class="queue-position">
          <p *ngIf="posicao" class="position-label">Posição na fila:</p>
          <div class="spinner-container">
            <div class="loading-spinner"></div>
            <div *ngIf="posicao" class="position-text">{{ posicao }}<sup>º</sup><br /><span>lugar</span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ========================================
         JANELA DE CONVERSA PRINCIPAL
         Exibida quando não está na fila de espera
         ======================================== -->
    <ng-container *ngIf="!estaEsperandoAtendimento">
      <!-- Janela de scroll das mensagens -->
      <div class="chat-window" #scrollRef (mousemove)="onChatWindowMouseMove($event)" (mouseleave)="onChatWindowMouseLeave()">
        
        <!-- ========================================
             LOOP DE MENSAGENS
             Tipos de mensagem:
             - IF: Mensagem informativa (separador)
             - US: Mensagem do usuário
             - AT: Mensagem do atendente
             - IA: Mensagem da IA
             - BT: Mensagem com botões/menus
             ======================================== -->
        <ng-container *ngFor="let msg of conversaSala">
          
          <!-- Mensagem informativa (separador) -->
          <div *ngIf="msg.olmTipo === 'IF'" class="info-atvd-chat">{{ msg.olmRespostaIa }}</div>
          
          <!-- Mensagens regulares (US, AT, IA, BT) -->
          <div *ngIf="msg.olmTipo !== 'IF'" 
               class="message-wrapper" 
               [ngClass]="{ 'you': msg.olmTipo === 'US', 'other': msg.olmTipo !== 'US', 'ia': msg.olmTipo === 'IA' }" 
               [attr.data-message-id]="msg.olmId">
            
            <!-- Nome do remetente -->
            <div class="sender-name">
              <ng-container>
                <ng-container *ngIf="msg.olmTipo === 'US'">Você:</ng-container>
                <ng-container *ngIf="msg.olmTipo === 'AT'">Atendente</ng-container>
                <ng-container *ngIf="msg.olmTipo === 'IA' || msg.olmTipo === 'AI' || msg.olmTipo === 'BT'">
                  <ng-container *ngIf="clientKey == 'C7VY7HCVF47H3F4'">MarIA</ng-container>
                  <ng-container *ngIf="clientKey == '49fa27aab4f70b8eaacf'">Lisi</ng-container>
                  <ng-container *ngIf="clientKey == '5237XCA0IU2VAR2D12BN'">Ana Clara</ng-container>
                  <ng-container *ngIf="clientKey == '938VF4YU8HVU8HVF4U8H'">Ana Clara</ng-container>
                  <ng-container *ngIf="clientKey == '954GBBG4NY73VF478VB5'">Chef B</ng-container>
                </ng-container>
              </ng-container>
              <!-- Botão TTS (Leitura de Texto) -->
              <button
                *ngIf="msg.olmTipo !== 'US' && lisiConfig.tts && clientKey == '49fa27aab4f70b8eaacf'"
                class="tts-play-btn"
                (click)="speechSynthesisService.toggleTtsMessage(msg, lisiConfig.tts, clientKey)"
                type="button"
                [title]="speechSynthesisService.isSpeaking() ? 'Parar' : 'Ouvir mensagem'"
                [attr.aria-label]="speechSynthesisService.isSpeaking() ? 'Parar' : 'Ouvir mensagem'">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M3 10v4h4l5 5V5L7 10H3zm13.5 2c0-1.77-1-3.29-2.5-4.03v8.06c1.5-.74 2.5-2.26 2.5-4.03z"/>
                </svg>
              </button>
            </div>
            
            <!-- Bolha da mensagem (clicável para reenviar se houver erro) -->
            <div class="message-bubble" 
                 (click)="msg.olmStatus === 'N' ? reenviarMsg(msg) : ''" 
                 [ngClass]="{ 'error-send': msg.olmStatus === 'N' }">
              <!-- ========================================
                   CONTEÚDO DA MENSAGEM
                   ======================================== -->
              <ng-container *ngIf="parseBotao(msg) as parsed; else textoSimples">
                <ng-container *ngIf="msg.olmTipo === 'BT' && parsed.menu; else textoSimples">
                  
                  <!-- Switch entre tipos de menu -->
                  <ng-container [ngSwitch]="parsed.menu">
                    
                    <!-- ========================================
                         TBO - Text with Buttons Options
                         Mensagem de texto com botões clicáveis
                         ======================================== -->
                    <ng-container *ngSwitchCase="'TBO'">
                      <p class="button-message" [innerHTML]="formatarTextoSimples(parsed.message)"></p>
                      <div class="button-options">
                        <button 
                          *ngFor="let btn of parsed.buttonList.buttons"
                          class="botao-chat"
                          [disabled]="isBTDisabled(msg)" 
                          [class.disabled]="isBTDisabled(msg)"
                          (click)="isLastBubble(msg) && !isBTDisabled(msg) && selecaoBotao(msg, btn)">
                          {{ btn.label }}
                        </button>
                      </div>
                    </ng-container>
                    
                    <!-- ========================================
                         LOP - List of Options
                         Lista de opções clicáveis
                         ======================================== -->
                    <ng-container *ngSwitchCase="'LOP'">
                      <p class="button-message" [innerHTML]="formatarTextoSimples(parsed.message)"></p>
                      <ul class="lista-opcoes" [class.disabled]="!isLastBubble(msg)">
                        <li 
                          *ngFor="let opt of parsed.optionList.options"
                          [class.disabled]="!isLastBubble(msg)"
                          (click)="isLastBubble(msg) && selecaoItem(msg, opt)">
                          {{ opt.title }}
                        </li>
                      </ul>
                    </ng-container>
                    
                    <!-- ========================================
                         TBA - Text with Button Actions
                         Mensagem com botões de ação (ligar, URL, responder)
                         ======================================== -->
                    <ng-container *ngSwitchCase="'TBA'">
                      <p class="button-message" [innerHTML]="formatarTextoSimples(parsed.message)"></p>
                      <div class="acoes" [class.disabled]="!isLastBubble(msg)">
                        <ng-container *ngFor="let act of parsed.buttonActions">
                          
                          <!-- Botão de ligação (tel:) -->
                          <a 
                            *ngIf="act.type === 'CALL'"
                            class="acao"
                            [class.disabled]="!isLastBubble(msg)"
                            [attr.tabindex]="isLastBubble(msg) ? null : -1"
                            [attr.aria-disabled]="!isLastBubble(msg)"
                            [href]="isLastBubble(msg) ? ('tel:' + act.phone) : null">
                            {{ act.label }}
                          </a>
                          
                          <!-- Botão de URL externa -->
                          <a 
                            *ngIf="act.type === 'URL'"
                            class="acao"
                            [class.disabled]="!isLastBubble(msg)"
                            [attr.tabindex]="isLastBubble(msg) ? null : -1"
                            [attr.aria-disabled]="!isLastBubble(msg)"
                            [href]="isLastBubble(msg) ? act.url : null" 
                            target="_blank" 
                            rel="noopener">
                            {{ act.label }}
                          </a>
                          
                          <!-- Botão de resposta -->
                          <button 
                            *ngIf="act.type === 'REPLY'"
                            class="acao"
                            [disabled]="!isLastBubble(msg)"
                            [class.disabled]="!isLastBubble(msg)"
                            (click)="isLastBubble(msg) && selecaoLinkReply(msg, act)">
                            {{ act.label }}
                          </button>
                        </ng-container>
                      </div>
                    </ng-container>
                    
                    <!-- ========================================
                         TXT - Text Message
                         Mensagem de texto simples
                         ======================================== -->
                    <ng-container *ngSwitchCase="'TXT'">
                      <p [innerHTML]="formatarTextoSimples(parsed.message)"></p>
                    </ng-container>
                    
                    <!-- ========================================
                         CAP - Caption
                         Legenda de mensagem
                         ======================================== -->
                    <ng-container *ngSwitchCase="'CAP'">
                      <p [innerHTML]="formatarTextoSimples(parsed.message)"></p>
                    </ng-container>
                    
                    <!-- Tipo de menu não reconhecido -->
                    <ng-container *ngSwitchDefault>
                      <p [innerHTML]="formatarTextoSimples(parsed.message)"></p>
                    </ng-container>
                    
                  </ng-container>
                </ng-container>
              </ng-container>
              
              <!-- Template para mensagem de texto simples (fallback) -->
              <ng-template #textoSimples>
                <ng-container *ngIf="msg.olmTipoMsg === 'IMG' || msg.olmTipoMsg === 'VID' || msg.olmTipoMsg === 'DOC'; else textoSimplesConteudo">
                  <div class="file-message">
                    <div class="file-header">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M5 21q-.825 0-1.412-.587T3 19V5q0-.825.588-1.412T5 3h14q.825 0 1.413.588T21 5v14q0 .825-.587 1.413T19 21zm0-2h14V5H5zm0 0V5zm2-2h10q.3 0 .45-.275t-.05-.525l-2.75-3.675q-.15-.2-.4-.2t-.4.2L11.25 16L9.4 13.525q-.15-.2-.4-.2t-.4.2l-2 2.675q-.2.25-.05.525T7 17m1.5-7q.625 0 1.063-.438T10 8.5t-.437-1.062T8.5 7t-1.062.438T7 8.5t.438 1.063T8.5 10"/></svg>
                      <div class="file-name">{{ getFileName(msg.olmMensagemCliente || msg.olmRespostaIa) }}</div>
                    </div>
                  </div>
                  <div class="file-actions" *ngIf="msg.olmTipoMsg === 'IMG' || msg.olmTipoMsg === 'VID' || msg.olmTipoMsg === 'DOC'; else textoSimplesConteudo">
                    <div class="button-show-actions" (click)="showActions = !showActions">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M12 14.975q-.2 0-.375-.062T11.3 14.7l-4.6-4.6q-.275-.275-.275-.7t.275-.7t.7-.275t.7.275l3.9 3.9l3.9-3.9q.275-.275.7-.275t.7.275t.275.7t-.275.7l-4.6 4.6q-.15.15-.325.213t-.375.062"/></svg>
                    </div>
                    <div class="actions" [class.show]="showActions">
                      <button *ngIf="msg.olmTipoMsg === 'IMG' || msg.olmTipoMsg === 'VID'" type="button" (click)="visualizarArquivo(msg)">Visualizar</button>
                      <button type="button" (click)="baixarArquivo(msg)">Baixar</button>
                    </div>
                  </div>
                </ng-container>
                <ng-template #textoSimplesConteudo>
                  <div class="message-content">
                    <!-- Player de áudio para mensagens de voz -->
                    <div *ngIf="msg.audioUrl && msg.audioMimeType" class="audio-player">
                      <audio controls [src]="msg.audioUrl" class="audio-element"></audio>
                      <!-- Mostrar transcrição se existir -->
                      <div *ngIf="msg.transcript" class="audio-transcript">
                        "{{ msg.transcript }}"
                      </div>
                    </div>
                    <!-- Texto normal (quando não é áudio) -->
                    <p *ngIf="!msg.audioUrl" [innerHTML]="msg.htmlFormatado || msg.olmRespostaIa || msg.olmMensagemCliente"></p>
                  </div>
                  <small class="mt-2 d-flex opacity-50" *ngIf="isSouceVisible && msg.olmRespostaIa">
                    {{ msg.source ? msg.source : 'Sem fonte' }}
                  </small>
                </ng-template>
              </ng-template>
              
              <!-- ========================================
                   INDICADORES DE STATUS DA MENSAGEM
                   P = Pendente (relógio)
                   E = Enviado (check simples)
                   A = Aceito/Recebido (check duplo)
                   N = Não enviado (erro - refresh)
                   ======================================== -->
              <ng-container [ngSwitch]="msg.olmStatus" *ngIf="msg.olmStatus" class="d-none">
                <!-- Pendente -->
                <span *ngSwitchCase="'P'" class="status">
                  <!-- <svg viewBox="0 0 16 15" width="16" preserveAspectRatio="xMidYMid meet" class="" version="1.1" x="0px" y="0px" enable-background="new 0 0 16 15"><title>msg-time</title><path fill="currentColor" d="M9.75,7.713H8.244V5.359c0-0.276-0.224-0.5-0.5-0.5H7.65c-0.276,0-0.5,0.224-0.5,0.5v2.947 c0,0.276,0.224,0.5,0.5,0.5h0.094c0.001,0,0.002-0.001,0.003-0.001S7.749,8.807,7.75,8.807h2c0.276,0,0.5-0.224,0.5-0.5V8.213 C10.25,7.937,10.026,7.713,9.75,7.713z M9.75,2.45h-3.5c-1.82,0-3.3,1.48-3.3,3.3v3.5c0,1.82,1.48,3.3,3.3,3.3h3.5 c1.82,0,3.3-1.48,3.3-3.3v-3.5C13.05,3.93,11.57,2.45,9.75,2.45z M11.75,9.25c0,1.105-0.895,2-2,2h-3.5c-1.104,0-2-0.895-2-2v-3.5 c0-1.104,0.896-2,2-2h3.5c1.105,0,2,0.896,2,2V9.25z"></path></svg> -->
                  <svg viewBox="0 0 16 11" height="11" width="16" preserveAspectRatio="xMidYMid meet" class="" fill="none"><title>msg-dblcheck</title><path d="M11.0714 0.652832C10.991 0.585124 10.8894 0.55127 10.7667 0.55127C10.6186 0.55127 10.4916 0.610514 10.3858 0.729004L4.19688 8.36523L1.79112 6.09277C1.7488 6.04622 1.69802 6.01025 1.63877 5.98486C1.57953 5.95947 1.51817 5.94678 1.45469 5.94678C1.32351 5.94678 1.20925 5.99544 1.11192 6.09277L0.800883 6.40381C0.707784 6.49268 0.661235 6.60482 0.661235 6.74023C0.661235 6.87565 0.707784 6.98991 0.800883 7.08301L3.79698 10.0791C3.94509 10.2145 4.11224 10.2822 4.29844 10.2822C4.40424 10.2822 4.5058 10.259 4.60313 10.2124C4.70046 10.1659 4.78086 10.1003 4.84434 10.0156L11.4903 1.59863C11.5623 1.5013 11.5982 1.40186 11.5982 1.30029C11.5982 1.14372 11.5348 1.01888 11.4078 0.925781L11.0714 0.652832ZM8.6212 8.32715C8.43077 8.20866 8.2488 8.09017 8.0753 7.97168C7.99489 7.89128 7.8891 7.85107 7.75791 7.85107C7.6098 7.85107 7.4892 7.90397 7.3961 8.00977L7.10411 8.33984C7.01947 8.43717 6.97715 8.54508 6.97715 8.66357C6.97715 8.79476 7.0237 8.90902 7.1168 9.00635L8.1959 10.0791C8.33132 10.2145 8.49636 10.2822 8.69102 10.2822C8.79681 10.2822 8.89838 10.259 8.99571 10.2124C9.09304 10.1659 9.17556 10.1003 9.24327 10.0156L15.8639 1.62402C15.9358 1.53939 15.9718 1.43994 15.9718 1.32568C15.9718 1.1818 15.9125 1.05697 15.794 0.951172L15.4386 0.678223C15.3582 0.610514 15.2587 0.57666 15.1402 0.57666C14.9964 0.57666 14.8715 0.635905 14.7657 0.754395L8.6212 8.32715Z" fill="currentColor"></path></svg>
                </span>
                
                <!-- Enviado -->
                <span *ngSwitchCase="'E'" class="status">
                  <svg viewBox="0 0 12 11" height="11" width="16" preserveAspectRatio="xMidYMid meet" class="" fill="none"><title>msg-check</title><path d="M11.1549 0.652832C11.0745 0.585124 10.9729 0.55127 10.8502 0.55127C10.7021 0.55127 10.5751 0.610514 10.4693 0.729004L4.28038 8.36523L1.87461 6.09277C1.8323 6.04622 1.78151 6.01025 1.72227 5.98486C1.66303 5.95947 1.60166 5.94678 1.53819 5.94678C1.407 5.94678 1.29275 5.99544 1.19541 6.09277L0.884379 6.40381C0.79128 6.49268 0.744731 6.60482 0.744731 6.74023C0.744731 6.87565 0.79128 6.98991 0.884379 7.08301L3.88047 10.0791C4.02859 10.2145 4.19574 10.2822 4.38194 10.2822C4.48773 10.2822 4.58929 10.259 4.68663 10.2124C4.78396 10.1659 4.86436 10.1003 4.92784 10.0156L11.5738 1.59863C11.6458 1.5013 11.6817 1.40186 11.6817 1.30029C11.6817 1.14372 11.6183 1.01888 11.4913 0.925781L11.1549 0.652832Z" fill="currentcolor"></path></svg>
                </span>
                
                <!-- Aceito -->
                <span *ngSwitchCase="'A'" class="status double-check">
                  <svg viewBox="0 0 16 11" height="11" width="16" preserveAspectRatio="xMidYMid meet" class="" fill="none"><title>msg-dblcheck</title><path d="M11.0714 0.652832C10.991 0.585124 10.8894 0.55127 10.7667 0.55127C10.6186 0.55127 10.4916 0.610514 10.3858 0.729004L4.19688 8.36523L1.79112 6.09277C1.7488 6.04622 1.69802 6.01025 1.63877 5.98486C1.57953 5.95947 1.51817 5.94678 1.45469 5.94678C1.32351 5.94678 1.20925 5.99544 1.11192 6.09277L0.800883 6.40381C0.707784 6.49268 0.661235 6.60482 0.661235 6.74023C0.661235 6.87565 0.707784 6.98991 0.800883 7.08301L3.79698 10.0791C3.94509 10.2145 4.11224 10.2822 4.29844 10.2822C4.40424 10.2822 4.5058 10.259 4.60313 10.2124C4.70046 10.1659 4.78086 10.1003 4.84434 10.0156L11.4903 1.59863C11.5623 1.5013 11.5982 1.40186 11.5982 1.30029C11.5982 1.14372 11.5348 1.01888 11.4078 0.925781L11.0714 0.652832ZM8.6212 8.32715C8.43077 8.20866 8.2488 8.09017 8.0753 7.97168C7.99489 7.89128 7.8891 7.85107 7.75791 7.85107C7.6098 7.85107 7.4892 7.90397 7.3961 8.00977L7.10411 8.33984C7.01947 8.43717 6.97715 8.54508 6.97715 8.66357C6.97715 8.79476 7.0237 8.90902 7.1168 9.00635L8.1959 10.0791C8.33132 10.2145 8.49636 10.2822 8.69102 10.2822C8.79681 10.2822 8.89838 10.259 8.99571 10.2124C9.09304 10.1659 9.17556 10.1003 9.24327 10.0156L15.8639 1.62402C15.9358 1.53939 15.9718 1.43994 15.9718 1.32568C15.9718 1.1818 15.9125 1.05697 15.794 0.951172L15.4386 0.678223C15.3582 0.610514 15.2587 0.57666 15.1402 0.57666C14.9964 0.57666 14.8715 0.635905 14.7657 0.754395L8.6212 8.32715Z" fill="currentColor"></path></svg>
                </span>
                
                <!-- Erro -->
                <span *ngSwitchCase="'N'" class="status" title="Erro ao enviar">
                  <i class="fi fi-rr-refresh"></i>
                </span>
              </ng-container>
            </div>
            
            <!-- ========================================
                 BOTÕES DE AVALIAÇÃO (Like/Dislike)
                 Exibidos apenas para mensagens da IA
                 ======================================== -->
            <div *ngIf="msg.olmTipo === 'IA'" 
                 class="rating-btns" 
                 [ngClass]="{ 'disabled': isRatingDisabled(msg.olmId) }">
              <!-- Botão Like -->
              <button class="rating-button like-button" 
                      [class.active]="getRating(msg.olmId) === 'like'" 
                      [disabled]="isRatingDisabled(msg.olmId)" 
                      (click)="submitRating(msg.olmId, 'like')">
                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3">
                  <path d="M840-640q32 0 56 24t24 56v80q0 7-2 15t-4 15L794-168q-9 20-30 34t-44 14H280v-520l240-238q15-15 35.5-17.5T595-888q19 10 28 28t4 37l-45 183h258Zm-480 34v406h360l120-280v-80H480l54-220-174 174ZM160-120q-33 0-56.5-23.5T80-200v-360q0-33 23.5-56.5T160-640h120v80H160v360h120v80H160Zm200-80v-406 406Z"></path>
                </svg>
              </button>
              
              <!-- Botão Dislike -->
              <button class="rating-button dislike-button" 
                      [class.active]="getRating(msg.olmId) === 'dislike'" 
                      [disabled]="isRatingDisabled(msg.olmId)" 
                      (click)="submitRating(msg.olmId, 'dislike')">
                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3">
                  <path d="M120-320q-32 0-56-24t-24-56v-80q0-7 2-15t4-15l120-282q9-20 30-34t44-14h440v520L440-82q-15 15-35.5 17.5T365-72q-19-10-28-28t-4-37l45-183H120Zm480-34v-406H240L120-480v80h360l-54 220 174-174Zm200-486q33 0 56.5 23.5T880-760v360q0 33-23.5 56.5T800-320H680v-80h120v-360H680v-80h120Zm-200 80v406-406Z"></path>
                </svg>
              </button>
            </div>
            
            <!-- Horário da mensagem -->
            <div class="message-time">
              <span *ngIf="msg.olmStatus !== 'N'">{{ formatarHoraSemFuso(msg.olmDatahoraRegistro) }}</span>
              <span *ngIf="msg.olmStatus === 'N'">Menssagem não enviada, clique para enviar.</span>
            </div>
            
          </div>
        </ng-container>
        
        <!-- ========================================
             INDICADOR DE "AGUARDANDO RESPOSTA"
             Bolha com loader exibida quando a última mensagem é do usuário
             ======================================== -->
        <div *ngIf="isWaitingForResponse" class="message-wrapper waiting-message">
          <div class="message-bubble">
            <div class="loader"></div>
          </div>
        </div>
        
        <!-- ========================================
             TELA DE FIM DE ATENDIMENTO
             Fluxo de avaliação em 3 etapas:
             1. Like/Dislike (demanda foi atendida?)
             2. Avaliação por estrelas (nível de satisfação)
             3. Mensagem de agradecimento
             ======================================== -->
        <div *ngIf="chatEnd" class="chat-end-container">
          <hr class="separator" />
          <h4>Atendimento finalizado!</h4>
          
          <!-- Etapa 1: Pergunta se a demanda foi atendida (Like/Dislike) -->
          <p *ngIf="likeDislike === true && avaliAtend === false" 
             class="end-message" 
             style="margin-top: 15px;">
            Sua demada foi atendida?
          </p>
          <div *ngIf="likeDislike === true && avaliAtend === false" class="likeDislike">
            <div (click)="avaliacaoLikeDeslike('S')">
              <i class="fi fi-rr-social-network like"></i>
            </div>
            <div (click)="avaliacaoLikeDeslike('N')">
              <i class="fi fi-rr-hand dislike"></i>
            </div>
          </div>
          
          <!-- Etapa 2: Avaliação por estrelas -->
          <p *ngIf="likeDislike === false && avaliAtend === true" 
             class="end-message" 
             style="margin-top: 15px;">
            Qual o seu nível de satisfação com as informações fornecidas?
          </p>
          <ngx-star-rating
              *ngIf="likeDislike === false && avaliAtend === true"
              [(ngModel)]="rating"
              [id]="'rating'"
              (ngModelChange)="avaliacaoAtendPost($event)">
          </ngx-star-rating>
          
          <!-- Etapa 3: Mensagem de agradecimento -->
          <p *ngIf="likeDislike === false && avaliAtend === false" 
             class="end-message" 
             style="margin-top: 15px;">
            Agradecemos por utilizar nosso atendimento!
          </p>
          <div *ngIf="likeDislike === false && avaliAtend === false" class="loading-spinner"></div>
        </div>
        
      </div>
      
      <!-- ========================================
           FORMULÁRIO DE ENVIO DE MENSAGEM
           Campo de input + botões de anexo e enviar
           Desabilitado quando: chat finalizado, enviando mensagem ou bloqueado
           ======================================== -->
      <div *ngIf="!chatEnd" class="chat-send-msg-form-group">
        <input
          type="text"
          class="chat-send-msg-input"
          maxlength="500"
          (keyup.enter)="enviarMensagem()"
          [(ngModel)]="mensagem"
          placeholder="Digite sua mensagem..."
          [disabled]="isSendingMessage || isInputBlocked">

        <!-- Botão de anexar arquivo com dropdown -->
        <!-- <div class="upload-btn-container" *ngIf="clientKey === '49fa27aab4f70b8eaacf'"> -->
        <div class="upload-btn-container" *ngIf="false">
          <button 
            class="chat-attach-btn" 
            (click)="toggleUploadMenu()"
            [disabled]="isSendingMessage || isInputBlocked"
            type="button">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
            </svg>
          </button>
          
          <!-- Dropdown de opções de upload -->
          <div class="upload-dropdown" *ngIf="showUploadMenu">
            <button class="upload-option" (click)="selecionarImagem()" type="button">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                <circle cx="8.5" cy="8.5" r="1.5"/>
                <polyline points="21 15 16 10 5 21"/>
              </svg>
              <span>Imagem</span>
            </button>
            
            <button class="upload-option" (click)="selecionarDocumento()" type="button">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
                <line x1="16" y1="13" x2="8" y2="13"/>
                <line x1="16" y1="17" x2="8" y2="17"/>
                <polyline points="10 9 9 9 8 9"/>
              </svg>
              <span>Documento</span>
            </button>
            
            <button class="upload-option" (click)="selecionarVideo()" type="button">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="23 7 16 12 23 17 23 7"/>
                <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
              </svg>
              <span>Vídeo</span>
            </button>
          </div>
        </div>
        
        <!-- Inputs hidden para seleção de arquivos -->
        <input 
          type="file" 
          id="input-imagem" 
          accept="image/*" 
          (change)="onImagemSelecionada($event)" 
          style="display: none;">
        <input 
          type="file" 
          id="input-documento" 
          accept=".pdf,.doc,.docx,.txt,.xls,.xlsx" 
          (change)="onDocumentoSelecionado($event)" 
          style="display: none;">
        <input 
          type="file" 
          id="input-video" 
          accept="video/*" 
          (change)="onVideoSelecionado($event)" 
          style="display: none;">
        
        <!-- Botão único dinâmico -->
        <button
          class="chat-send-msg-btn"
          [class.chat-stt-btn]="!mensagem.trim() && lisiConfig.stt && clientKey == '49fa27aab4f70b8eaacf' && !hasPendingVoiceMessage()"
          [class.recording]="isRecording"
          (click)="(!mensagem.trim() && lisiConfig.stt && clientKey == '49fa27aab4f70b8eaacf' && !hasPendingVoiceMessage()) ? toggleSttRecording() : enviarMensagem()"
          [disabled]="!(mensagem.trim() || hasPendingVoiceMessage() || (!mensagem.trim() && lisiConfig.stt && clientKey == '49fa27aab4f70b8eaacf' && !hasPendingVoiceMessage())) || isSendingMessage || isInputBlocked"
          [title]="(!mensagem.trim() && lisiConfig.stt && clientKey == '49fa27aab4f70b8eaacf' && !hasPendingVoiceMessage()) ? 'Gravar áudio' : 'Enviar mensagem'"
          type="button">

          <!-- Estado: Microfone (input vazio, STT ativado, sem voz pendente) -->
          <ng-container *ngIf="!mensagem.trim() && lisiConfig.stt && clientKey == '49fa27aab4f70b8eaacf' && !hasPendingVoiceMessage()">
            <!-- Ícone de microfone (normal) -->
            <svg *ngIf="!isRecording && !isSendingMessage" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 14a3 3 0 0 0 3-3V6a3 3 0 0 0-6 0v5a3 3 0 0 0 3 3z"/>
              <path d="M19 11a7 7 0 0 1-14 0"/>
              <path d="M12 19v3"/>
            </svg>
            <!-- Ícone de parar (gravando) -->
            <svg *ngIf="isRecording && !isSendingMessage" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="6" y="6" width="12" height="12" fill="currentColor"/>
            </svg>
          </ng-container>

          <!-- Estado: Enviar (texto presente OU voz pendente) -->
          <ng-container *ngIf="mensagem.trim() || hasPendingVoiceMessage() || !(lisiConfig.stt && clientKey == '49fa27aab4f70b8eaacf')">
            <img *ngIf="!isSendingMessage" src="assets/icons/chat--send.svg" alt="">
          </ng-container>

          <!-- Loading (sempre visível quando enviando) -->
          <div *ngIf="isSendingMessage" class="loading-spinner-small"></div>
        </button>
      </div>
      
    </ng-container>
  </div>
  
</div>

<!-- Modal de upload -->
<div *ngIf="uploadModalOpen" class="upload-modal-overlay" (click)="closeUploadModal()">
  <div class="upload-modal-body" (click)="onUploadModalBodyClick($event)">
    <div class="upload-modal-header">
      <div class="upload-modal-header-title">
        <strong>{{ uploadModalType === 'IMG' ? 'Imagem' : uploadModalType === 'DOC' ? 'Documento' : 'Vídeo' }}</strong>
        <span *ngIf="selectedUploadFile">{{ selectedUploadFile.name }}</span>
      </div>
      <button type="button" class="upload-modal-header-close" (click)="closeUploadModal()">Fechar</button>
    </div>
    <div class="upload-modal-body-content">
      <div class="upload-drop-area" [class.dragover]="uploadModalDragOver" (dragover)="onDragOverUpload($event)" (dragleave)="onDragLeaveUpload($event)" (drop)="onDropUpload($event)">
        <ng-container *ngIf="!selectedUploadFile; else previewTpl">
          <div class="upload-drop-content">
            <div>Arraste e solte um arquivo aqui</div>
            <div>ou</div>
            <div>
              <button type="button" class="upload-drop-button" (click)="modalFileInput.click()">Selecionar arquivo</button>
              <input type="file" #modalFileInput [accept]="getAcceptForCurrentType()" (change)="onUploadFileInputChange($event)" class="upload-drop-input" />
            </div>
          </div>
        </ng-container>
        <ng-template #previewTpl>
          <div class="upload-preview-container">
            <img *ngIf="uploadModalType==='IMG' && selectedUploadPreviewSafeUrl" [src]="selectedUploadPreviewSafeUrl" alt="preview" class="upload-preview-img"/>
            <video *ngIf="uploadModalType==='VID' && selectedUploadPreviewSafeUrl" [src]="selectedUploadPreviewSafeUrl" controls class="upload-preview-video"></video>
            <div *ngIf="uploadModalType==='DOC'" class="upload-preview-doc">
              <div>{{ selectedUploadFile?.name }}</div>
              <div class="upload-preview-doc-type">{{ selectedUploadFile?.type }}</div>
            </div>
          </div>
        </ng-template>
      </div>
      <div class="upload-modal-footer">
        <div class="upload-status-list">
          <div class="upload-status-item">
            <div class="upload-status-dot" [ngClass]="{'loading': stepStatusSolic === 'loading', 'success': stepStatusSolic === 'success', 'error': stepStatusSolic === 'error'}"></div>
            <span class="upload-status-text">Solicitando link</span>
          </div>
          <div class="upload-status-item">
            <div class="upload-status-dot" [ngClass]="{'loading': stepStatusUpload === 'loading', 'success': stepStatusUpload === 'success', 'error': stepStatusUpload === 'error'}"></div>
            <span class="upload-status-text">Enviando arquivo</span>
          </div>
          <div class="upload-status-item">
            <div class="upload-status-dot" [ngClass]="{'loading': stepStatusSend === 'loading', 'success': stepStatusSend === 'success', 'error': stepStatusSend === 'error'}"></div>
            <span class="upload-status-text">Enviando mensagem</span>
          </div>
        </div>
        <div class="upload-footer-buttons">
          <button type="button" class="upload-cancel-button" (click)="closeUploadModal()">Cancelar</button>
          <button type="button" class="upload-send-button" (click)="confirmUploadFromModal()" [disabled]="!selectedUploadFile || stepStatusSolic === 'loading' || stepStatusUpload === 'loading' || stepStatusSend === 'loading' || !salaPrincipal?.ombProtocolo">Enviar</button>
        </div>
      </div>
    </div>
  </div>
</div>